<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Little Pearly Daily Lucky</title>
</head>
<body>
<div class="lp-lucky-wrap">
  <div class="lp-title">ì˜¤ëŠ˜ì˜ í–‰ìš´ì„ ë½‘ì•„ë³´ì„¸ìš”!!</div>

  <!-- ë³´ë“œ(ìƒ˜í”Œ) -->
  <div class="lp-board">
    <button class="lp-clover" type="button" aria-label="ë„¤ìí´ë¡œë²„"></button>
    <button class="lp-clover" type="button" aria-label="ë„¤ìí´ë¡œë²„"></button>
    <button class="lp-clover" type="button" aria-label="ë„¤ìí´ë¡œë²„"></button>
    <button class="lp-clover" type="button" aria-label="ë„¤ìí´ë¡œë²„"></button>
    <button class="lp-clover" type="button" aria-label="ë„¤ìí´ë¡œë²„"></button>
    <button class="lp-clover" type="button" aria-label="ë„¤ìí´ë¡œë²„"></button>
    <button class="lp-clover" type="button" aria-label="ë„¤ìí´ë¡œë²„"></button>
    <button class="lp-clover" type="button" aria-label="ë„¤ìí´ë¡œë²„"></button>
    <button class="lp-clover" type="button" aria-label="ë„¤ìí´ë¡œë²„"></button>
    <button class="lp-clover" type="button" aria-label="ë„¤ìí´ë¡œë²„"></button>
  </div>

  <div class="lp-help" id="lpHelp"></div>
</div>

<!-- íŒì—… -->
<div class="lp-modal" id="lpModal" aria-hidden="true">
  <div class="lp-modal__dim" data-close></div>
  <div class="lp-modal__card" role="dialog" aria-modal="true" aria-labelledby="lpModalTitle">
    <div class="lp-modal__title" id="lpModalTitle">ì§ ! ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!</div>
    <div class="lp-modal__desc">
      ì ë¦½ê¸ˆ <b class="lp-modal__amount" id="lpModalAmount">0ì›</b> ë‹¹ì²¨!
    </div>
    <div class="lp-modal__fineprint">
      í•´ë‹¹ ì ë¦½ê¸ˆì€ 30ì¼ ì´ë‚´ì— ì‚¬ìš© ê°€ëŠ¥í•˜ë©°,<br/>
      ë§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤!
    </div>
    <button class="lp-modal__btn" type="button" data-close>í™•ì¸</button>
  </div>
</div>

<style>
  /* ===== Layout ===== */
  .lp-lucky-wrap{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
    padding: 40px 16px;
    text-align:center;
  }
  .lp-title{
    font-weight:800;
    font-size: 22px;
    margin-bottom: 22px;
  }
  .lp-help{
    margin-top: 14px;
    font-size: 14px;
    color: #777;
    min-height: 18px;
  }

  /* ===== Board ===== */
  .lp-board{
    display:grid;
    grid-template-columns: repeat(5, minmax(58px, 86px));
    gap: 18px;
    justify-content:center;
    align-items:center;
  }

  /* ===== Clover button ===== */
  .lp-clover{
    width: 86px;
    height: 86px;
    border: 0;
    background: transparent;
    cursor: pointer;
    position: relative;
    outline: none;
    transform-origin: 50% 50%;
  }

  /* í•˜ëŠ˜ìƒ‰ ë„¤ìí´ë¡œë²„ (CSSë¡œ ê°„ë‹¨ í‘œí˜„) */
  .lp-clover::before{
    content:"";
    position:absolute;
    inset: 0;
    margin:auto;
    width: 72px;
    height: 72px;
    background: #79d2ff;
    border-radius: 18px;
    /* ë„¤ì ëŠë‚Œ */
    clip-path: path("M36 10 C26 0 10 6 10 22 C10 32 18 38 24 40 C18 42 10 48 10 60 C10 76 26 82 36 72 C46 82 62 76 62 60 C62 48 54 42 48 40 C54 38 62 32 62 22 C62 6 46 0 36 10 Z");
  }

  /* í´ë¦­ í›„ í•‘í¬ í´ë¡œë²„ */
  .lp-clover.is-won::before{
    background:#ff86b6;
  }

  /* ê°€ìš´ë° ê¸ˆì•¡ í…ìŠ¤íŠ¸ */
  .lp-clover .lp-amount{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight: 900;
    color:#fff;
    font-size: 18px;
    text-shadow: 0 1px 0 rgba(0,0,0,.08);
  }

  /* 3ì´ˆ íšŒì „(ì˜¤ë¥¸ìª½) + ì„œì„œíˆ ë©ˆì¶¤ ëŠë‚Œ */
  .lp-clover.is-spinning{
    animation: lpSpinStop 3s cubic-bezier(0.12, 0.72, 0.08, 1) forwards;
  }
  @keyframes lpSpinStop{
    0%   { transform: rotate(0deg) scale(1); }
    10%  { transform: rotate(360deg) scale(1.03); }
    40%  { transform: rotate(1440deg) scale(1.03); }
    70%  { transform: rotate(2160deg) scale(1.02); }
    100% { transform: rotate(2520deg) scale(1); } /* ì´ 7ë°”í€´(ì˜¤ë¥¸ìª½) */
  }

  .lp-clover:disabled{
    cursor:not-allowed;
    opacity:.55;
  }

  /* ===== Modal ===== */
  .lp-modal{
    position:fixed;
    inset:0;
    display:none;
    z-index: 99999;
  }
  .lp-modal.is-open{ display:block; }
  .lp-modal__dim{
    position:absolute;
    inset:0;
    background: rgba(0,0,0,.35);
  }
  .lp-modal__card{
    position:absolute;
    left:50%;
    top:50%;
    transform: translate(-50%,-50%);
    width: min(420px, calc(100% - 32px));
    background:#ff86b6;
    border-radius: 16px;
    padding: 22px 18px 16px;
    box-shadow: 0 18px 50px rgba(0,0,0,.28);
    color:#fff;
  }
  .lp-modal__title{
    font-size: 22px;
    font-weight: 900;
    margin-bottom: 10px;
  }
  .lp-modal__desc{
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 14px;
  }
  .lp-modal__amount{
    font-size: 28px;
    font-weight: 1000;
  }
  .lp-modal__fineprint{
    font-size: 14px;
    opacity:.92;
    line-height: 1.35;
    margin-bottom: 14px;
  }
  .lp-modal__btn{
    width:100%;
    height: 44px;
    border-radius: 12px;
    border:0;
    background:#fff;
    color:#ff4f9a;
    font-weight: 900;
    cursor:pointer;
  }
</style>

<script>
(() => {
  /**
   * ====== (í•„ìˆ˜) íšŒì› ì²´í¬ ======
   * ì•„ì„ì›¹ í™˜ê²½ì—ì„œ íšŒì› ì •ë³´ ì ‘ê·¼ì€ ì‚¬ì´íŠ¸ ì„¤ì •/ìŠ¤í‚¨ì— ë”°ë¼ ë‹¤ë¦…ë‹ˆë‹¤.
   * ì•„ë˜ getMemberId()ë§Œ â€œí˜„ì¬ ì‚¬ì´íŠ¸ì—ì„œ ì‹¤ì œë¡œ ë‚˜ì˜¤ëŠ” ê°’â€ì— ë§ê²Œ ìˆ˜ì •í•˜ë©´ ë©ë‹ˆë‹¤.
   */

 function getMemberId() {
  return "TEST_USER"; // GitHub í…ŒìŠ¤íŠ¸ ì „ìš©
}

  const memberId = getMemberId();
  const helpEl = document.getElementById("lpHelp");
  const modalEl = document.getElementById("lpModal");
  const modalAmountEl = document.getElementById("lpModalAmount");

  const todayKey = new Date().toISOString().slice(0,10); // YYYY-MM-DD
  const storageKey = memberId ? `LP_LUCKY_${memberId}_${todayKey}` : null;

  // ì´ë¯¸ ì˜¤ëŠ˜ ì°¸ì—¬í–ˆëŠ”ì§€
  function hasClaimedToday() {
    if (!storageKey) return false;
    return localStorage.getItem(storageKey) === "claimed";
  }
  function markClaimed() {
    if (!storageKey) return;
    localStorage.setItem(storageKey, "claimed");
  }

  /**
   * ====== í™•ë¥  ëª¨ë¸ ======
   * - 100ì›: 80%
   * - 1000ì›: 0.1%
   * - 110~990(10ì›ë‹¨ìœ„): ì´ 19.9%ë¥¼ "110ì›ì´ ê°€ì¥ í¬ê³ , 990ì›ì´ ê°€ì¥ ì‘ê²Œ"
   *   + (110 : 990) í™•ë¥  ë¹„ìœ¨ì´ (80 : 0.1)ì— ê°€ê¹ë„ë¡ ì§€ìˆ˜ê°ì†Œ(ê¸°í•˜ê¸‰ìˆ˜)ë¡œ ê°€ì¤‘ì¹˜ ë°°ë¶„
   */
  const P_100 = 0.80;
  const P_1000 = 0.001;
  const P_MID_TOTAL = 1 - P_100 - P_1000; // 0.199

  const mids = [];
  for (let v = 110; v <= 990; v += 10) mids.push(v);

  // 110ì´ ê°€ì¥ ë†’ê³  990ì´ ê°€ì¥ ë‚®ê²Œ: ratio â‰ˆ 800 (80 / 0.1)
  const ratio = 800;
  const n = mids.length; // 89
  // ê¸°í•˜ê¸‰ìˆ˜ ê°ì†Œ: w[i] = r^(-i/(n-1))  (w0=1, wLast=1/ratio)
  const weights = mids.map((_, i) => Math.pow(ratio, -i / (n - 1)));
  const wSum = weights.reduce((a,b) => a + b, 0);
  const midProb = weights.map(w => (w / wSum) * P_MID_TOTAL);

  // CDF ë§Œë“¤ê¸°
  const cdf = [];
  let acc = 0;

  // 100ì›
  acc += P_100;
  cdf.push({ amount: 100, acc });

  // 110~990
  for (let i = 0; i < mids.length; i++) {
    acc += midProb[i];
    cdf.push({ amount: mids[i], acc });
  }

  // 1000ì›
  acc = 1; // ë¶€ë™ì†Œìˆ˜ ì˜¤ì°¨ ë°©ì§€
  cdf.push({ amount: 1000, acc: 1 });

  function drawAmount() {
    const r = Math.random();
    for (const row of cdf) {
      if (r <= row.acc) return row.amount;
    }
    return 100; // fallback
  }

  /**
   * ====== íŒì—… ======
   */
  function openModal(amount) {
    modalAmountEl.textContent = `${amount.toLocaleString()}ì›`;
    modalEl.classList.add("is-open");
    modalEl.setAttribute("aria-hidden", "false");
  }
  function closeModal() {
    modalEl.classList.remove("is-open");
    modalEl.setAttribute("aria-hidden", "true");
  }
  modalEl.addEventListener("click", (e) => {
    if (e.target.matches("[data-close]")) closeModal();
  });

  /**
   * ====== (ì„ íƒ) ì„œë²„ì— ì ë¦½ê¸ˆ ì§€ê¸‰ ìš”ì²­ ======
   * ì‹¤ì œ ìš´ì˜ì€ ë°˜ë“œì‹œ ì„œë²„ì—ì„œ:
   *  - íšŒì› ì¸ì¦(ì„¸ì…˜/í† í°)
   *  - 1ì¼ 1íšŒ ì²´í¬
   *  - ëœë¤ ê²°ê³¼ í™•ì • & DB ì €ì¥
   *  - ì ë¦½ê¸ˆ ì§€ê¸‰ ì²˜ë¦¬
   *
   * ì•„ë˜ í•¨ìˆ˜ëŠ” â€œí›…â€ë§Œ ë§Œë“¤ì–´ë‘” ê²ë‹ˆë‹¤. (ì§€ê¸ˆì€ í”„ë¡ íŠ¸ ëœë¤ ê²°ê³¼ë¥¼ ë³´ë‚´ëŠ” í˜•íƒœ)
   */
  async function grantPointsOnServer(amount) {
    // TODO: ìš´ì˜ ì‹œ, ì´ ë¶€ë¶„ì„ ì‹¤ì œ APIë¡œ êµì²´í•˜ì„¸ìš”.
    // ì˜ˆì‹œ:
    // const res = await fetch("/api/lucky-grant", {
    //   method: "POST",
    //   headers: { "Content-Type": "application/json" },
    //   body: JSON.stringify({ amount }),
    //   credentials: "include"
    // });
    // if (!res.ok) throw new Error("server error");
    // return await res.json();
    return { ok: true };
  }

  /**
   * ====== í´ë¦­ ë¡œì§ ======
   */
  const clovers = Array.from(document.querySelectorAll(".lp-clover"));

  // íšŒì› ì œí•œ
  if (!memberId) {
    helpEl.textContent = "ë¡œê·¸ì¸ í›„ ì°¸ì—¬í•  ìˆ˜ ìˆì–´ìš”!";
    clovers.forEach(btn => btn.disabled = true);
    return;
  }

  // ì˜¤ëŠ˜ ì´ë¯¸ ì°¸ì—¬í–ˆìœ¼ë©´ ë¹„í™œì„±
  if (hasClaimedToday()) {
    helpEl.textContent = "ì˜¤ëŠ˜ì€ ì´ë¯¸ ì°¸ì—¬í–ˆì–´ìš”! ë‚´ì¼ ë˜ ì™€ì£¼ì„¸ìš” ğŸ’—";
    clovers.forEach(btn => btn.disabled = true);
    return;
  } else {
    helpEl.textContent = "í•˜ëŠ˜ìƒ‰ ë„¤ìí´ë¡œë²„ë¥¼ ëˆŒëŸ¬ ì˜¤ëŠ˜ì˜ í–‰ìš´ì„ ë½‘ì•„ë³´ì„¸ìš”!";
  }

  // 1íšŒë§Œ ê°€ëŠ¥: ì²« í´ë¦­ ì´í›„ ì ê¸ˆ
  let locked = false;

  clovers.forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (locked) return;
      locked = true;
      clovers.forEach(b => b.disabled = true);

      // ë‹¹ì²¨ ê¸ˆì•¡
      const amount = drawAmount();

      // 3ì´ˆ íšŒì „ ì‹œì‘
      btn.classList.add("is-spinning");

      // 3ì´ˆ í›„: í•‘í¬ë¡œ ë°”ê¾¸ê³  ê¸ˆì•¡ í‘œì‹œ
      setTimeout(() => {
        btn.classList.remove("is-spinning");
        btn.classList.add("is-won");

        const amountEl = document.createElement("div");
        amountEl.className = "lp-amount";
        amountEl.textContent = `${amount.toLocaleString()}ì›`;
        btn.appendChild(amountEl);
      }, 3000);

      // íšŒì „ ëë‚œ ë’¤ 1ì´ˆ í›„ íŒì—…
      setTimeout(async () => {
        try {
          // (ìš´ì˜ ì‹œ) ì„œë²„ ì§€ê¸‰
          await grantPointsOnServer(amount);

          // ì˜¤ëŠ˜ ì™„ë£Œ ì²˜ë¦¬(í…ŒìŠ¤íŠ¸ëŠ” ë¡œì»¬)
          markClaimed();
          openModal(amount);
          helpEl.textContent = "ë‚´ì¼ë„ ë‹¤ì‹œ ì°¸ì—¬í•  ìˆ˜ ìˆì–´ìš”!";
        } catch (err) {
          // ì‹¤íŒ¨ ì‹œ: ì ê¸ˆ í•´ì œ(í…ŒìŠ¤íŠ¸ í¸ì˜)
          locked = false;
          clovers.forEach(b => b.disabled = false);
          helpEl.textContent = "ì§€ê¸‰ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
          console.error(err);
        }
      }, 4000);
    });
  });
})();
</script>

</body>
</html>
